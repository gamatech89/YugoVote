<?php
/**
 * Template Name: My Account
 * Template Post Type: page
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// This page is only for logged-in users.
if (!is_user_logged_in()) {
    // Redirect to login page if not logged in. Ensure CUSTOM_LOGIN_PAGE_SLUG is defined.
    $login_page_url = defined('CUSTOM_LOGIN_PAGE_SLUG') ? home_url('/' . CUSTOM_LOGIN_PAGE_SLUG . '/') : wp_login_url(get_permalink());
    wp_redirect($login_page_url);
    exit;
}

$current_user = wp_get_current_user(); // Get the currently logged-in user object

get_header(); 
?>

<main id="site-content" role="main" class="cs-custom-auth-page cs-my-account-page">
    <div class="cs-account-container"> {/* You might want a container for overall padding/max-width */}
        
        <header class="cs-account-header">
            <h1><?php esc_html_e('Moj Nalog', 'your-text-domain'); // My Account ?></h1>
            <?php 
            // Display a success message if redirected from profile completion
            if (isset($_GET['profile_completed']) && $_GET['profile_completed'] === 'true') {
                echo '<p class="cs-auth-message cs-auth-success">' . esc_html__('Va≈°i podaci su uspe≈°no saƒçuvani!', 'your-text-domain') . '</p>'; // Your details have been successfully saved!
            }
            // Display a message if redirected from new registration
            if (isset($_GET['new_registration']) && $_GET['new_registration'] === 'true' && defined('CUSTOM_COMPLETE_PROFILE_PAGE_SLUG')) {
                 // This message might be redundant if they just completed profile, but good if they skipped.
                 // Or maybe link them to complete profile if certain fields are still missing.
                 $complete_profile_url = home_url('/' . CUSTOM_COMPLETE_PROFILE_PAGE_SLUG . '/');
                 echo '<p class="cs-auth-message cs-auth-info">' . sprintf(wp_kses_post(__('Dobrodo≈°li! Mo≈æda ≈æelite da <a href="%s">kompletirate Va≈° profil</a>?', 'your-text-domain')), esc_url($complete_profile_url)) . '</p>';
            }
            ?>
        </header>

        <div class="cs-account-layout">
            <aside class="cs-account-sidebar">
                <nav class="cs-account-navigation">
                    <ul>
                        <?php
                        // Define sidebar navigation items
                        // We'll use query vars for now to switch content in main area, or direct links
                        $account_page_url = home_url('/' . CUSTOM_ACCOUNT_PAGE_SLUG . '/'); // Or get_permalink() if on the page

                        $nav_items = [
                            'dashboard' => [
                                'title' => __('Pregled', 'your-text-domain'), // Overview
                                'url' => $account_page_url,
                                'icon' => 'üè†' // Placeholder, replace with SVG or icon class
                            ],
                            'edit-profile' => [ // To edit basic WP profile + Gender, DOB, Country, Interests
                                'title' => __('Izmeni Profil', 'your-text-domain'), // Edit Profile
                                // For now, link to WP Admin profile page. Later, we can build a front-end form.
                                'url' => get_edit_profile_url($current_user->ID), 
                                'icon' => 'üë§'
                            ],
                            // Placeholders for future links based on your requirements
                            'my-quizzes' => [
                                'title' => __('Moji Kvizovi', 'your-text-domain'), // My Quizzes
                                'url' => '#', // Replace with actual link when ready
                                'icon' => '‚ùì'
                            ],
                            'my-points' => [
                                'title' => __('Moji Poeni & Nivoi', 'your-text-domain'), // My Points & Levels
                                'url' => '#',
                                'icon' => 'üèÜ'
                            ],
                        ];

                        // Add other links like "Order History", "Settings" etc. as needed

                        // Determine current view for active class (basic example)
                        $current_view = isset($_GET['view']) ? sanitize_key($_GET['view']) : 'dashboard';

                        foreach ($nav_items as $slug => $item) {
                            $class = ($current_view === $slug) ? 'cs-active-nav' : '';
                            echo '<li><a href="' . esc_url($item['url']) . '" class="' . esc_attr($class) . '">' . esc_html($item['icon']) . ' ' . esc_html($item['title']) . '</a></li>';
                        }
                        ?>
                        <li>
                            <a href="<?php echo esc_url(wp_logout_url(home_url('/' . CUSTOM_LOGIN_PAGE_SLUG . '/'))); ?>">
                                <?php esc_html_e('üö™ Odjava', 'your-text-domain'); // Logout ?>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <section class="cs-account-content">
                <?php
                // Content for the "My Account" page sections will go here.
                // For now, a welcome message or basic info.
                // Later, we can load different content based on query vars (e.g., $_GET['view'])
                
                if ($current_view === 'dashboard' || empty($current_view)) {
                    echo '<h2>' . sprintf(esc_html__('Dobrodo≈°li nazad, %s!', 'your-text-domain'), esc_html($current_user->display_name)) . '</h2>'; // Welcome back
                    echo '<p>' . esc_html__('Sa ove stranice mo≈æete pregledati Va≈°e aktivnosti i upravljati Va≈°im nalogom.', 'your-text-domain') . '</p>'; // From this page you can view your activity and manage your account.
                    
                    // Display some basic info (examples)
                    echo '<h3>' . esc_html__('Informacije o nalogu:', 'your-text-domain') . '</h3>';
                    echo '<ul>';
                    echo '<li><strong>' . esc_html__('Korisniƒçko ime:', 'your-text-domain') . '</strong> ' . esc_html($current_user->user_login) . '</li>';
                    echo '<li><strong>' . esc_html__('Email:', 'your-text-domain') . '</strong> ' . esc_html($current_user->user_email) . '</li>';
                    
                    // Display custom fields if they exist
                    $user_gender = get_user_meta($current_user->ID, '_user_gender', true);
                    $user_dob = get_user_meta($current_user_id, '_user_dob', true); // YYYY-MM-DD format
                    $user_country = get_user_meta($current_user->ID, '_user_country', true);
                    $user_interests_ids = get_user_meta($current_user->ID, '_user_points_of_interest', true);

                    if ($user_gender) echo '<li><strong>' . esc_html__('Pol:', 'your-text-domain') . '</strong> ' . esc_html(ucfirst($user_gender)) . '</li>';
                    if ($user_dob) echo '<li><strong>' . esc_html__('Datum roƒëenja:', 'your-text-domain') . '</strong> ' . esc_html(date_format(date_create($user_dob), 'd.m.Y')) . '</li>'; // Format date
                    if ($user_country) echo '<li><strong>' . esc_html__('Dr≈æava:', 'your-text-domain') . '</strong> ' . esc_html($user_country) . '</li>';
                    
                    if (!empty($user_interests_ids) && is_array($user_interests_ids)) {
                        $interest_names = [];
                        foreach($user_interests_ids as $term_id) {
                            $term = get_term($term_id, 'voting_list_category');
                            if ($term && !is_wp_error($term)) {
                                $interest_names[] = esc_html($term->name);
                            }
                        }
                        if(!empty($interest_names)){
                             echo '<li><strong>' . esc_html__('Interesovanja:', 'your-text-domain') . '</strong> ' . implode(', ', $interest_names) . '</li>';
                        }
                    }
                    echo '</ul>';

                } elseif ($current_view === 'edit-profile') {
                    // This currently links to WP Admin. If you build a front-end form, load it here.
                    echo '<h2>' . esc_html__('Izmeni Profil', 'your-text-domain') . '</h2>';
                    echo '<p>' . sprintf(wp_kses_post(__('Profil mo≈æete izmeniti na <a href="%s">standardnoj WordPress stranici za izmenu profila</a>.', 'your-text-domain')), esc_url(get_edit_profile_url($current_user->ID))) . '</p>';
                    echo '<p>' . esc_html__('Uskoro ƒáemo dodati moguƒánost izmene svih podataka direktno ovde.', 'your-text-domain') . '</p>'; // We will soon add the ability to edit all data directly here.
                
                } elseif ($current_view === 'my-quizzes') {
                     echo '<h2>' . esc_html__('Moji Kvizovi', 'your-text-domain') . '</h2>';
                     echo '<p>' . esc_html__('Ova sekcija je u pripremi.', 'your-text-domain') . '</p>'; // This section is under construction.
                
                } elseif ($current_view === 'my-points') {
                     echo '<h2>' . esc_html__('Moji Poeni & Nivoi', 'your-text-domain') . '</h2>';
                     echo '<p>' . esc_html__('Ova sekcija je u pripremi.', 'your-text-domain') . '</p>'; // This section is under construction.
                }
                // Add more elseif blocks here for other views based on sidebar clicks
                ?>
            </section>
        </div>
    </div>
</main>

<?php
get_footer(); 
?>